<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickServe - Enhanced Professional Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 32px;
            font-weight: 700;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #ffffff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            background: none;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50, #388e3c);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4CAF50, #2196F3, #FF9800, #9C27B0);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-weight: 500;
        }

        .stat-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s ease;
        }

        .data-table tr:hover td {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: #fafafa;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .form-textarea {
            width: 100%;
            min-height: 100px;
            resize: vertical;
        }

        .search-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .search-form {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            align-items: end;
        }

        .search-input {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .portfolio-item {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .portfolio-item:hover {
            transform: translateY(-5px);
        }

        .portfolio-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .portfolio-content {
            padding: 20px;
        }

        .certificate-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .business-hours-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .day-hours {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .message.success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .message.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .message.info {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .hidden {
            display: none !important;
        }

        .verified-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .rating-stars {
            color: #ffc107;
            font-size: 18px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 15px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: 700;
        }

        .tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: 500;
        }

        .tab.active {
            background: rgba(255,255,255,0.2);
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .nav {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-buttons {
                justify-content: center;
            }
            
            .search-form {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="nav">
                <div class="logo">
                    <i class="fas fa-bolt"></i> QuickServe Pro
                </div>
                <div class="nav-buttons" id="navButtons">
                    <!-- Navigation will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="mainContent">
            <!-- Content will be loaded here dynamically -->
        </div>
    </div>

    <!-- Modals will be added here dynamically -->

    <script>
        // Global variables
        let currentUser = null;
        let currentView = 'home';
        let authToken = localStorage.getItem('quickserve_token');
        const API_BASE = 'http://localhost/QuickServe/api';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Check if user is already logged in
            if (authToken) {
                await verifyToken();
            }

            updateNavigation();
            showView('home');
        }

        async function verifyToken() {
            try {
                const response = await fetch(`${API_BASE}/auth.php?action=profile`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data.data;
                } else {
                    localStorage.removeItem('quickserve_token');
                    authToken = null;
                }
            } catch (error) {
                console.error('Token verification failed:', error);
                localStorage.removeItem('quickserve_token');
                authToken = null;
            }
        }

        function updateNavigation() {
            const navButtons = document.getElementById('navButtons');
            
            if (currentUser) {
                let buttons = `
                    <button class="btn btn-outline" onclick="showView('home')">
                        <i class="fas fa-home"></i> Home
                    </button>
                    <button class="btn btn-outline" onclick="showView('services')">
                        <i class="fas fa-list"></i> Services
                    </button>
                `;

                if (currentUser.role === 'admin') {
                    buttons += `
                        <button class="btn btn-secondary" onclick="showView('admin-dashboard')">
                            <i class="fas fa-tachometer-alt"></i> Admin Panel
                        </button>
                    `;
                } else if (currentUser.role === 'provider') {
                    buttons += `
                        <button class="btn btn-secondary" onclick="showView('provider-dashboard')">
                            <i class="fas fa-briefcase"></i> My Dashboard
                        </button>
                        <button class="btn btn-outline" onclick="showView('my-profile')">
                            <i class="fas fa-user"></i> Profile
                        </button>
                    `;
                } else {
                    buttons += `
                        <button class="btn btn-outline" onclick="showView('my-bookings')">
                            <i class="fas fa-calendar"></i> My Bookings
                        </button>
                        <button class="btn btn-outline" onclick="showView('my-profile')">
                            <i class="fas fa-user"></i> Profile
                        </button>
                    `;
                }

                buttons += `
                    <button class="btn btn-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                `;

                navButtons.innerHTML = buttons;
            } else {
                navButtons.innerHTML = `
                    <button class="btn btn-outline" onclick="showView('home')">
                        <i class="fas fa-home"></i> Home
                    </button>
                    <button class="btn btn-outline" onclick="showView('services')">
                        <i class="fas fa-list"></i> Services
                    </button>
                    <button class="btn btn-primary" onclick="showAuthModal()">
                        <i class="fas fa-sign-in-alt"></i> Login / Sign Up
                    </button>
                `;
            }
        }

        // View management functions
        function showView(viewName) {
            currentView = viewName;
            const mainContent = document.getElementById('mainContent');
            
            switch(viewName) {
                case 'home':
                    showHomeView();
                    break;
                case 'services':
                    showServicesView();
                    break;
                case 'admin-dashboard':
                    if (currentUser && currentUser.role === 'admin') {
                        showAdminDashboard();
                    } else {
                        showMessage('Access denied', 'error');
                    }
                    break;
                case 'provider-dashboard':
                    if (currentUser && currentUser.role === 'provider') {
                        showProviderDashboard();
                    } else {
                        showMessage('Access denied', 'error');
                    }
                    break;
                case 'my-profile':
                    if (currentUser) {
                        showProfileView();
                    } else {
                        showAuthModal();
                    }
                    break;
                case 'my-bookings':
                    if (currentUser) {
                        showBookingsView();
                    } else {
                        showAuthModal();
                    }
                    break;
                default:
                    showHomeView();
            }
        }

        function showHomeView() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="search-section">
                    <h2 style="margin-bottom: 20px; color: #333; font-size: 2rem;">Find Professional Services Near You</h2>
                    <div class="search-form">
                        <div class="form-group" style="margin-bottom: 0;">
                            <input type="text" class="search-input" id="searchInput" placeholder="Search for services, locations, or providers...">
                        </div>
                        <button class="btn btn-primary" onclick="searchServices()">
                            <i class="fas fa-search"></i> Search
                        </button>
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            <option value="plumbing">Plumbing</option>
                            <option value="cleaning">Cleaning</option>
                            <option value="electrical">Electrical</option>
                            <option value="painting">Painting</option>
                            <option value="carpentry">Carpentry</option>
                            <option value="gardening">Gardening</option>
                        </select>
                    </div>
                </div>
                <div id="servicesContainer">
                    <!-- Services will be loaded here -->
                </div>
            `;
            loadServices();
        }

        async function showAdminDashboard() {
            const mainContent = document.getElementById('mainContent');
            
            // Show loading
            mainContent.innerHTML = `
                <div class="card" style="text-align: center; padding: 50px;">
                    <div class="loading" style="margin: 0 auto 20px;"></div>
                    <p>Loading admin dashboard...</p>
                </div>
            `;

            try {
                // Load dashboard stats
                const response = await fetch(`${API_BASE}/admin.php?action=get-dashboard-stats`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    renderAdminDashboard(data.data);
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Failed to load admin dashboard:', error);
                showMessage('Failed to load dashboard', 'error');
            }
        }

        function renderAdminDashboard(dashboardData) {
            const mainContent = document.getElementById('mainContent');
            const stats = dashboardData.stats;
            
            mainContent.innerHTML = `
                <div class="card" style="margin-bottom: 30px;">
                    <h2 style="color: #333; margin-bottom: 10px;">
                        <i class="fas fa-tachometer-alt"></i> Admin Dashboard
                    </h2>
                    <p style="color: #666; margin-bottom: 20px;">Platform Overview & Management</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-number">${stats.totalUsers}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-briefcase"></i></div>
                        <div class="stat-number">${stats.totalProviders}</div>
                        <div class="stat-label">Service Providers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-user-friends"></i></div>
                        <div class="stat-number">${stats.totalCustomers}</div>
                        <div class="stat-label">Customers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-cog"></i></div>
                        <div class="stat-number">${stats.totalServices}</div>
                        <div class="stat-label">Active Services</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                        <div class="stat-number">${stats.totalBookings}</div>
                        <div class="stat-label">Total Bookings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-shield-alt"></i></div>
                        <div class="stat-number">${stats.verifiedProviders}</div>
                        <div class="stat-label">Verified Providers</div>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="showAdminTab('users')">
                        <i class="fas fa-users"></i> User Management
                    </div>
                    <div class="tab" onclick="showAdminTab('services')">
                        <i class="fas fa-cog"></i> Services
                    </div>
                    <div class="tab" onclick="showAdminTab('bookings')">
                        <i class="fas fa-calendar"></i> Bookings
                    </div>
                    <div class="tab" onclick="showAdminTab('certificates')">
                        <i class="fas fa-certificate"></i> Certificates
                    </div>
                    <div class="tab" onclick="showAdminTab('actions')">
                        <i class="fas fa-history"></i> Action Log
                    </div>
                </div>

                <div id="adminTabContent">
                    <!-- Tab content will be loaded here -->
                </div>
            `;

            // Show users tab by default
            showAdminTab('users');
        }

        async function showAdminTab(tabName) {
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            const tabContent = document.getElementById('adminTabContent');

            switch(tabName) {
                case 'users':
                    await loadUserManagement();
                    break;
                case 'services':
                    await loadServiceManagement();
                    break;
                case 'bookings':
                    await loadBookingManagement();
                    break;
                case 'certificates':
                    await loadCertificateManagement();
                    break;
                case 'actions':
                    await loadActionLog();
                    break;
            }
        }

        async function loadUserManagement() {
            const tabContent = document.getElementById('adminTabContent');
            
            try {
                const response = await fetch(`${API_BASE}/admin.php?action=get-users`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    renderUserManagement(data.data.users);
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                showMessage('Failed to load users', 'error');
            }
        }

        function renderUserManagement(users) {
            const tabContent = document.getElementById('adminTabContent');
            
            tabContent.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3><i class="fas fa-users"></i> User Management</h3>
                        <div>
                            <select id="userFilter" onchange="filterUsers()" class="form-select" style="width: auto;">
                                <option value="all">All Users</option>
                                <option value="provider">Providers</option>
                                <option value="customer">Customers</option>
                                <option value="admin">Admins</option>
                            </select>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Services/Bookings</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            ${users.map(user => `
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div class="profile-avatar" style="width: 40px; height: 40px; font-size: 1rem;">
                                                ${user.full_name.charAt(0).toUpperCase()}
                                            </div>
                                            <div>
                                                <strong>${user.full_name}</strong>
                                                ${user.is_verified ? '<span class="verified-badge"><i class="fas fa-check"></i> Verified</span>' : ''}
                                                <br>
                                                <small style="color: #666;">${user.email}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge badge-${user.role === 'admin' ? 'danger' : user.role === 'provider' ? 'info' : 'success'}">
                                            ${user.role}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge badge-${user.is_blocked ? 'danger' : 'success'}">
                                            ${user.is_blocked ? 'Blocked' : 'Active'}
                                        </span>
                                    </td>
                                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                    <td>
                                        ${user.role === 'provider' ? `${user.total_services} services` : `${user.total_bookings} bookings`}
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 5px;">
                                            ${!user.is_blocked ? 
                                                `<button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="blockUser(${user.id})">
                                                    <i class="fas fa-ban"></i> Block
                                                </button>` :
                                                `<button class="btn btn-success" style="padding: 5px 10px; font-size: 12px;" onclick="unblockUser(${user.id})">
                                                    <i class="fas fa-check"></i> Unblock
                                                </button>`
                                            }
                                            ${!user.is_verified && user.role === 'provider' ? 
                                                `<button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="verifyUser(${user.id})">
                                                    <i class="fas fa-shield-alt"></i> Verify
                                                </button>` :
                                                user.is_verified ? 
                                                    `<button class="btn btn-outline" style="padding: 5px 10px; font-size: 12px;" onclick="unverifyUser(${user.id})">
                                                        <i class="fas fa-times"></i> Remove Verification
                                                    </button>` : ''
                                            }
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Admin action functions
        async function blockUser(userId) {
            const reason = prompt('Please provide a reason for blocking this user:');
            if (!reason) return;

            try {
                const response = await fetch(`${API_BASE}/admin.php?action=block-user`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId, reason })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('User blocked successfully', 'success');
                    loadUserManagement(); // Refresh the list
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Failed to block user:', error);
                showMessage('Failed to block user', 'error');
            }
        }

        async function unblockUser(userId) {
            try {
                const response = await fetch(`${API_BASE}/admin.php?action=unblock-user`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('User unblocked successfully', 'success');
                    loadUserManagement(); // Refresh the list
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Failed to unblock user:', error);
                showMessage('Failed to unblock user', 'error');
            }
        }

        async function verifyUser(userId) {
            try {
                const response = await fetch(`${API_BASE}/admin.php?action=verify-user`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('User verified successfully', 'success');
                    loadUserManagement(); // Refresh the list
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Failed to verify user:', error);
                showMessage('Failed to verify user', 'error');
            }
        }

        // Admin: Certificates management
        async function loadCertificateManagement() {
            const tabContent = document.getElementById('adminTabContent');
            tabContent.innerHTML = `<div class='card' style='text-align:center'><div class='loading' style='margin:10px auto;'></div> Loading certificates...</div>`;
            try {
                const res = await fetch(`${API_BASE}/admin.php?action=get-certificates&status=pending`, {
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (data.success) {
                    const certs = data.data.certificates;
                    tabContent.innerHTML = `
                        <div class='card'>
                            <h3 style='margin-top:0'><i class='fas fa-certificate'></i> Pending Certificates</h3>
                            ${certs.length === 0 ? '<p style="color:#666">No pending certificates</p>' : certs.map(c => `
                                <div class='certificate-item'>
                                    <div>
                                        <strong>${c.title}</strong>
                                        <div style='color:#666'>${c.user_name} · ${c.issuing_organization||''} · ${c.issue_date||''}</div>
                                        ${c.certificate_url ? `<a href='${c.certificate_url}' target='_blank'>View Document</a>`:''}
                                    </div>
                                    <div style='display:flex; gap:8px;'>
                                        <button class='btn btn-success' onclick='approveCert(${c.id})'><i class="fas fa-check"></i> Approve</button>
                                        <button class='btn btn-danger' onclick='rejectCert(${c.id})'><i class="fas fa-times"></i> Reject</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    showMessage(data.message, 'error');
                }
            } catch(e) {
                console.error(e); showMessage('Failed to load certificates', 'error');
            }
        }

        async function approveCert(id) {
            try {
                const res = await fetch(`${API_BASE}/admin.php?action=approve-certificate`, { method:'POST', headers:{ 'Authorization':`Bearer ${authToken}`, 'Content-Type':'application/json' }, body: JSON.stringify({ certificateId: id }) });
                const data = await res.json();
                if (data.success) { showMessage('Certificate approved','success'); loadCertificateManagement(); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to approve','error'); }
        }

        async function rejectCert(id) {
            const reason = prompt('Reason for rejection (optional)','');
            try {
                const res = await fetch(`${API_BASE}/admin.php?action=reject-certificate`, { method:'POST', headers:{ 'Authorization':`Bearer ${authToken}`, 'Content-Type':'application/json' }, body: JSON.stringify({ certificateId: id, reason }) });
                const data = await res.json();
                if (data.success) { showMessage('Certificate rejected','success'); loadCertificateManagement(); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to reject','error'); }
        }

        // Admin: Action log
        async function loadActionLog() {
            const tabContent = document.getElementById('adminTabContent');
            tabContent.innerHTML = `<div class='card' style='text-align:center'><div class='loading' style='margin:10px auto;'></div> Loading action log...</div>`;
            try {
                const res = await fetch(`${API_BASE}/admin.php?action=get-admin-actions`, { headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } });
                const data = await res.json();
                if (data.success) {
                    const actions = data.data.actions;
                    tabContent.innerHTML = `
                        <div class='card'>
                            <h3 style='margin-top:0'><i class='fas fa-history'></i> Admin Action Log</h3>
                            <table class='data-table'>
                                <thead><tr><th>When</th><th>Admin</th><th>Action</th><th>Target</th><th>Notes</th></tr></thead>
                                <tbody>
                                    ${actions.map(a => `
                                        <tr>
                                            <td>${new Date(a.created_at).toLocaleString()}</td>
                                            <td>${a.admin_name}</td>
                                            <td>${a.action_type.replace('_',' ')}</td>
                                            <td>${a.target_user_name || a.target_service_id || a.target_certificate_id || '-'}</td>
                                            <td>${a.notes || ''}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    showMessage(data.message, 'error');
                }
            } catch(e) {
                console.error(e); showMessage('Failed to load actions', 'error');
            }
        }

        // Continue with more functions...

        // Provider profile tabs
        async function showProfileTab(tab) {
            // Update active state
            const tabs = document.querySelectorAll('.tabs .tab');
            tabs.forEach(t => t.classList.remove('active'));
            const titles = { 'portfolio':'Portfolio', 'certificates':'Certificates', 'business-hours':'Business Hours', 'provider-profile':'Business Details' };
            for (const t of tabs) { if (t.innerText.includes(titles[tab])) { t.classList.add('active'); break; } }

            const container = document.getElementById('profileTabContent');
            container.innerHTML = `<div class="card" style="text-align:center"><div class="loading" style="margin:10px auto;"></div> Loading ${titles[tab]}...</div>`;
            try {
                if (tab === 'portfolio') {
                    const res = await fetch(`${API_BASE}/profiles.php?action=get-portfolio`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                    const data = await res.json();
                    if (data.success) renderPortfolio(data.data.portfolio); else showMessage(data.message,'error');
                } else if (tab === 'certificates') {
                    const res = await fetch(`${API_BASE}/profiles.php?action=get-certificates`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                    const data = await res.json();
                    if (data.success) renderCertificates(data.data.certificates); else showMessage(data.message,'error');
                } else if (tab === 'business-hours') {
                    const res = await fetch(`${API_BASE}/profiles.php?action=get-business-hours`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                    const data = await res.json();
                    if (data.success) renderBusinessHours(data.data.businessHours); else showMessage(data.message,'error');
                } else if (tab === 'service-areas') {
                    const res = await fetch(`${API_BASE}/profiles.php?action=get-service-areas`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                    const data = await res.json();
                    if (data.success) renderServiceAreas(data.data.serviceAreas); else showMessage(data.message,'error');
                } else if (tab === 'work-experience') {
                    const res = await fetch(`${API_BASE}/profiles.php?action=get-work-experience`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                    const data = await res.json();
                    if (data.success) renderWorkExperience(data.data.workExperience); else showMessage(data.message,'error');
                } else if (tab === 'provider-profile') {
                    const res = await fetch(`${API_BASE}/profiles.php?action=get-provider-profile`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                    const data = await res.json();
                    if (data.success) renderProviderProfile(data.data.providerProfile); else showMessage(data.message,'error');
                }
            } catch (e) { console.error(e); showMessage('Failed to load', 'error'); }
        }

        function renderPortfolio(items) {
            const container = document.getElementById('profileTabContent');
            container.innerHTML = `
                <div class="card" style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0"><i class="fas fa-images"></i> Portfolio</h3>
                    <button class="btn btn-primary" onclick="openAddPortfolioModal()"><i class="fas fa-plus"></i> Add Item</button>
                </div>
                <div class="portfolio-grid">
                    ${items.map(item => `
                        <div class="portfolio-item">
                            ${item.image_url ? `<img class='portfolio-image' src='${item.image_url}' alt='${item.title}'>` : `<div style='height:200px;display:flex;align-items:center;justify-content:center;background:#eee'>No Image</div>`}
                            <div class="portfolio-content">
                                <h4>${item.title}</h4>
                                <p style="color:#666;margin:8px 0">${item.description || ''}</p>
                                <div style="display:flex; gap:8px;">
                                    <button class="btn btn-outline" onclick="openEditPortfolioModal(${item.id})"><i class="fas fa-edit"></i> Edit</button>
                                    <button class="btn btn-danger" onclick="deletePortfolio(${item.id})"><i class="fas fa-trash"></i> Delete</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function openAddPortfolioModal(existing=null) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'portfolioModal';
            const isEdit = !!existing;
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">${isEdit ? 'Edit' : 'Add'} Portfolio Item</h2>
                        <span class="close" onclick="closeModal('portfolioModal')">&times;</span>
                    </div>
                    <div class="form-group"><label class="form-label">Title</label><input id="pf_title" class="form-input" value="${existing?.title||''}"></div>
                    <div class="form-group"><label class="form-label">Description</label><textarea id="pf_desc" class="form-input form-textarea">${existing?.description||''}</textarea></div>
                    <div class="form-group"><label class="form-label">Image URL</label><input id="pf_img" class="form-input" value="${existing?.image_url||''}" placeholder="https://..."></div>
                    <div class="form-group"><label class="form-label">Video URL</label><input id="pf_vid" class="form-input" value="${existing?.video_url||''}" placeholder="https://..."></div>
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button class="btn btn-outline" onclick="closeModal('portfolioModal')">Cancel</button>
                        <button class="btn btn-primary" onclick="${isEdit ? `savePortfolio(${existing?.id})` : 'createPortfolio()'}">${isEdit ? 'Save Changes' : 'Add Item'}</button>
                    </div>
                </div>`;
            document.body.appendChild(modal); modal.style.display='block';
        }

        async function createPortfolio() {
            const body = {
                title: document.getElementById('pf_title').value,
                description: document.getElementById('pf_desc').value,
                imageUrl: document.getElementById('pf_img').value,
                videoUrl: document.getElementById('pf_vid').value
            };
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=add-portfolio-item`, { method:'POST', headers:{ 'Authorization':`Bearer ${authToken}`, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success) { closeModal('portfolioModal'); showProfileTab('portfolio'); showMessage('Portfolio item added','success'); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to add portfolio','error'); }
        }

        function openEditPortfolioModal(id) {
            // For simplicity, reuse add modal but prefill requires fetching list again; We'll collect from DOM would be heavy; just prompt quick edit flow
            // Minimal: ask for new values via prompts (keeps UI simple now)
            const title = prompt('Title'); if (title===null) return;
            const description = prompt('Description',''); if (description===null) return;
            const imageUrl = prompt('Image URL',''); if (imageUrl===null) return;
            const videoUrl = prompt('Video URL',''); if (videoUrl===null) return;
            savePortfolio(id, {title, description, imageUrl, videoUrl});
        }

        async function savePortfolio(id, values) {
            const body = Object.assign({ id }, values || {
                title: document.getElementById('pf_title').value,
                description: document.getElementById('pf_desc').value,
                imageUrl: document.getElementById('pf_img').value,
                videoUrl: document.getElementById('pf_vid').value
            });
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=update-portfolio-item`, { method:'PUT', headers:{ 'Authorization':`Bearer ${authToken}`, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success) { closeModal('portfolioModal'); showProfileTab('portfolio'); showMessage('Portfolio item updated','success'); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to update portfolio','error'); }
        }

        async function deletePortfolio(id) {
            if (!confirm('Delete this portfolio item?')) return;
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=delete-portfolio-item&id=${id}`, { method:'DELETE', headers:{ 'Authorization':`Bearer ${authToken}` }});
                const data = await res.json();
                if (data.success) { showProfileTab('portfolio'); showMessage('Portfolio item deleted','success'); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to delete portfolio','error'); }
        }

        function renderCertificates(items) {
            const container = document.getElementById('profileTabContent');
            container.innerHTML = `
                <div class="card" style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0"><i class="fas fa-certificate"></i> Certificates</h3>
                    <button class="btn btn-primary" onclick="openAddCertificateModal()"><i class="fas fa-plus"></i> Add Certificate</button>
                </div>
                <div>
                    ${items.map(c => `
                        <div class='certificate-item'>
                            <div>
                                <strong>${c.title}</strong>
                                <div style='color:#666'>${c.issuing_organization || ''} · ${c.issue_date || ''}</div>
                                <div class='badge ${c.verification_status==='verified'?'badge-success': c.verification_status==='pending'?'badge-warning':'badge-danger'}' style='display:inline-block;margin-top:6px;'>${c.verification_status}</div>
                            </div>
                            <div style='display:flex; gap:8px;'>
                                ${c.certificate_url ? `<a class='btn btn-outline' href='${c.certificate_url}' target='_blank'><i class="fas fa-link"></i> View</a>`:''}
                                <button class='btn btn-danger' onclick='deleteCertificate(${c.id})'><i class="fas fa-trash"></i> Delete</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function openAddCertificateModal() {
            const modal = document.createElement('div');
            modal.className = 'modal'; modal.id = 'certModal';
            modal.innerHTML = `
                <div class='modal-content'>
                    <div class='modal-header'><h2 class='modal-title'>Add Certificate</h2><span class='close' onclick="closeModal('certModal')">&times;</span></div>
                    <div class='form-group'><label class='form-label'>Title</label><input id='ct_title' class='form-input'></div>
                    <div class='form-group'><label class='form-label'>Issuing Organization</label><input id='ct_org' class='form-input'></div>
                    <div class='form-group'><label class='form-label'>Certificate URL</label><input id='ct_url' class='form-input' placeholder='https://...'></div>
                    <div class='form-group'><label class='form-label'>Issue Date</label><input id='ct_issue' type='date' class='form-input'></div>
                    <div class='form-group'><label class='form-label'>Expiry Date</label><input id='ct_exp' type='date' class='form-input'></div>
                    <div class='form-group'><label class='form-label'>Type</label><select id='ct_type' class='form-select'><option value='certification'>Certification</option><option value='license'>License</option><option value='award'>Award</option><option value='training'>Training</option></select></div>
                    <div class='form-group'><label class='form-label'>Description</label><textarea id='ct_desc' class='form-input form-textarea'></textarea></div>
                    <div style='display:flex; gap:10px; justify-content:flex-end;'>
                        <button class='btn btn-outline' onclick="closeModal('certModal')">Cancel</button>
                        <button class='btn btn-primary' onclick='addCertificate()'>Add Certificate</button>
                    </div>
                </div>`;
            document.body.appendChild(modal); modal.style.display='block';
        }

        async function addCertificate() {
            const body = {
                title: document.getElementById('ct_title').value,
                issuingOrganization: document.getElementById('ct_org').value,
                certificateUrl: document.getElementById('ct_url').value,
                issueDate: document.getElementById('ct_issue').value,
                expiryDate: document.getElementById('ct_exp').value,
                certificateType: document.getElementById('ct_type').value,
                description: document.getElementById('ct_desc').value
            };
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=add-certificate`, { method:'POST', headers:{ 'Authorization':`Bearer ${authToken}`, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success) { closeModal('certModal'); showProfileTab('certificates'); showMessage('Certificate added','success'); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to add certificate','error'); }
        }

        async function deleteCertificate(id) {
            if (!confirm('Delete this certificate?')) return;
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=delete-certificate&id=${id}`, { method:'DELETE', headers:{ 'Authorization':`Bearer ${authToken}` }});
                const data = await res.json();
                if (data.success) { showProfileTab('certificates'); showMessage('Certificate deleted','success'); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to delete certificate','error'); }
        }

        function renderServiceAreas(items) {
            const container = document.getElementById('profileTabContent');
            container.innerHTML = `
                <div class='card' style='margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;'>
                    <h3 style='margin:0'><i class='fas fa-map-marker-alt'></i> Service Areas</h3>
                    <button class='btn btn-primary' onclick='openAddServiceAreaModal()'><i class="fas fa-plus"></i> Add Area</button>
                </div>
                <div>
                    ${items.map(a => `
                        <div class='certificate-item'>
                            <div>
                                <strong>${a.area_name}</strong>
                                <div style='color:#666'>${a.city}, ${a.state} ${a.pincode||''}</div>
                                <small>Charge: ₹${a.service_charge||0} · Travel: ${a.travel_time_minutes||0} min ${a.is_primary? "· PRIMARY": ''}</small>
                            </div>
                            <div style='display:flex; gap:8px;'>
                                <button class='btn btn-outline' onclick='openEditServiceAreaModal(${a.id})'><i class="fas fa-edit"></i> Edit</button>
                                <button class='btn btn-danger' onclick='deleteServiceArea(${a.id})'><i class="fas fa-trash"></i> Delete</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function openAddServiceAreaModal(existing=null) {
            const modal = document.createElement('div'); modal.className='modal'; modal.id='saModal';
            const e=existing||{};
            modal.innerHTML = `
                <div class='modal-content'>
                    <div class='modal-header'><h2 class='modal-title'>${existing? 'Edit':'Add'} Service Area</h2><span class='close' onclick="closeModal('saModal')">&times;</span></div>
                    <div class='form-group'><label class='form-label'>Area Name</label><input id='sa_name' class='form-input' value='${e.area_name||''}'></div>
                    <div class='form-group' style='display:flex; gap:10px;'>
                        <input id='sa_city' class='form-input' placeholder='City' value='${e.city||''}'>
                        <input id='sa_state' class='form-input' placeholder='State' value='${e.state||''}'>
                        <input id='sa_pin' class='form-input' placeholder='Pincode' value='${e.pincode||''}'>
                    </div>
                    <div class='form-group' style='display:flex; gap:10px;'>
                        <input id='sa_lat' class='form-input' placeholder='Latitude' value='${e.latitude||''}'>
                        <input id='sa_lng' class='form-input' placeholder='Longitude' value='${e.longitude||''}'>
                    </div>
                    <div class='form-group' style='display:flex; gap:10px;'>
                        <input id='sa_charge' class='form-input' placeholder='Service Charge (₹)' value='${e.service_charge||0}'>
                        <input id='sa_travel' class='form-input' placeholder='Travel Time (min)' value='${e.travel_time_minutes||0}'>
                        <select id='sa_primary' class='form-select'><option value='0' ${e.is_primary? '':'selected'}>Secondary</option><option value='1' ${e.is_primary? 'selected':''}>Primary</option></select>
                    </div>
                    <div style='display:flex; gap:10px; justify-content:flex-end;'>
                        <button class='btn btn-outline' onclick="closeModal('saModal')">Cancel</button>
                        <button class='btn btn-primary' onclick='${existing? `saveServiceArea(${e.id})` : 'createServiceArea()'}'>${existing? 'Save':'Add'} Area</button>
                    </div>
                </div>`;
            document.body.appendChild(modal); modal.style.display='block';
        }

        async function createServiceArea() {
            const body = {
                areaName: document.getElementById('sa_name').value,
                city: document.getElementById('sa_city').value,
                state: document.getElementById('sa_state').value,
                pincode: document.getElementById('sa_pin').value,
                latitude: parseFloat(document.getElementById('sa_lat').value||'0'),
                longitude: parseFloat(document.getElementById('sa_lng').value||'0'),
                serviceCharge: parseFloat(document.getElementById('sa_charge').value||'0'),
                travelTimeMinutes: parseInt(document.getElementById('sa_travel').value||'0',10),
                isPrimary: document.getElementById('sa_primary').value==='1'
            };
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=add-service-area`, { method:'POST', headers:{ 'Authorization':`Bearer ${authToken}`, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success) { closeModal('saModal'); showProfileTab('service-areas'); showMessage('Service area added','success'); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to add service area','error'); }
        }

        async function saveServiceArea(id) {
            const body = {
                id,
                areaName: document.getElementById('sa_name').value,
                city: document.getElementById('sa_city').value,
                state: document.getElementById('sa_state').value,
                pincode: document.getElementById('sa_pin').value,
                latitude: parseFloat(document.getElementById('sa_lat').value||'0'),
                longitude: parseFloat(document.getElementById('sa_lng').value||'0'),
                serviceCharge: parseFloat(document.getElementById('sa_charge').value||'0'),
                travelTimeMinutes: parseInt(document.getElementById('sa_travel').value||'0',10),
                isPrimary: document.getElementById('sa_primary').value==='1'
            };
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=update-service-area`, { method:'PUT', headers:{ 'Authorization':`Bearer ${authToken}`, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success) { closeModal('saModal'); showProfileTab('service-areas'); showMessage('Service area updated','success'); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to update service area','error'); }
        }

        async function deleteServiceArea(id) {
            if (!confirm('Delete this service area?')) return;
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=delete-service-area&id=${id}`, { method:'DELETE', headers:{ 'Authorization':`Bearer ${authToken}` }});
                const data = await res.json();
                if (data.success) { showProfileTab('service-areas'); showMessage('Service area deleted','success'); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to delete service area','error'); }
        }

        function renderBusinessHours(hours) {
            const container = document.getElementById('profileTabContent');
            const days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
            const map = {}; (hours||[]).forEach(h => map[h.day_of_week] = h);
            container.innerHTML = `
                <div class='card' style='margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;'>
                    <h3 style='margin:0'><i class='fas fa-clock'></i> Business Hours</h3>
                    <button class='btn btn-primary' onclick='saveBusinessHours()'><i class="fas fa-save"></i> Save</button>
                </div>
                <div class='business-hours-grid'>
                    ${days.map(d => `
                        <div class='day-hours'>
                            <strong style='text-transform:capitalize'>${d}</strong>
                            <div class='form-group' style='margin-top:8px;'>
                                <label class='form-label'>Open?</label>
                                <select class='form-select' id='bh_${d}_open'>
                                    <option value='1' ${map[d]?.is_open? 'selected':''}>Yes</option>
                                    <option value='0' ${map[d]?.is_open? '':'selected'}>No</option>
                                </select>
                            </div>
                            <div style='display:flex; gap:8px;'>
                                <input type='time' class='form-input' id='bh_${d}_start' value='${map[d]?.open_time||"09:00:00"}'>
                                <input type='time' class='form-input' id='bh_${d}_end' value='${map[d]?.close_time||"18:00:00"}'>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function saveBusinessHours() {
            const days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
            const payload = days.map(d => ({ dayOfWeek: d, isOpen: document.getElementById(`bh_${d}_open`).value==='1', openTime: document.getElementById(`bh_${d}_start`).value, closeTime: document.getElementById(`bh_${d}_end`).value, is24Hours: false }));
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=update-business-hours`, { method:'PUT', headers:{ 'Authorization':`Bearer ${authToken}`, 'Content-Type':'application/json' }, body: JSON.stringify({ businessHours: payload }) });
                const data = await res.json();
                if (data.success) showMessage('Business hours updated','success'); else showMessage(data.message,'error');
            } catch(e){ showMessage('Failed to update business hours','error'); }
        }

        function renderWorkExperience(items) {
            const container = document.getElementById('profileTabContent');
            container.innerHTML = `
                <div class='card' style='margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;'>
                    <h3 style='margin:0'><i class='fas fa-user-tie'></i> Work Experience</h3>
                    <button class='btn btn-primary' onclick='openAddWorkExpModal()'><i class="fas fa-plus"></i> Add Experience</button>
                </div>
                <div>
                    ${items.map(w => `
                        <div class='certificate-item'>
                            <div>
                                <strong>${w.position || ''}</strong> @ ${w.company_name || ''}
                                <div style='color:#666'>${w.start_date || ''} - ${w.is_current ? 'Present' : (w.end_date || '')}</div>
                                <div style='color:#666'>${w.description || ''}</div>
                            </div>
                            <div style='display:flex; gap:8px;'>
                                <button class='btn btn-outline' onclick='openEditWorkExpModal(${w.id})'><i class="fas fa-edit"></i> Edit</button>
                                <button class='btn btn-danger' onclick='deleteWorkExp(${w.id})'><i class="fas fa-trash"></i> Delete</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function openAddWorkExpModal(existing=null) {
            const modal = document.createElement('div'); modal.className='modal'; modal.id='weModal'; const e = existing||{};
            modal.innerHTML = `
                <div class='modal-content'>
                    <div class='modal-header'><h2 class='modal-title'>${existing? 'Edit':'Add'} Work Experience</h2><span class='close' onclick="closeModal('weModal')">&times;</span></div>
                    <div class='form-group'><label class='form-label'>Company</label><input id='we_company' class='form-input' value='${e.company_name||''}'></div>
                    <div class='form-group'><label class='form-label'>Position</label><input id='we_position' class='form-input' value='${e.position||''}'></div>
                    <div class='form-group' style='display:flex; gap:10px;'>
                        <input id='we_start' type='date' class='form-input' value='${e.start_date||''}'>
                        <input id='we_end' type='date' class='form-input' value='${e.end_date||''}'>
                        <select id='we_current' class='form-select'><option value='0' ${e.is_current? '':'selected'}>Past</option><option value='1' ${e.is_current? 'selected':''}>Current</option></select>
                    </div>
                    <div class='form-group'><label class='form-label'>Description</label><textarea id='we_desc' class='form-input form-textarea'>${e.description||''}</textarea></div>
                    <div style='display:flex; gap:10px; justify-content:flex-end;'>
                        <button class='btn btn-outline' onclick="closeModal('weModal')">Cancel</button>
                        <button class='btn btn-primary' onclick='${existing? `saveWorkExp(${e.id})` : 'createWorkExp()'}'>${existing? 'Save':'Add'} Experience</button>
                    </div>
                </div>`;
            document.body.appendChild(modal); modal.style.display='block';
        }

        async function createWorkExp() {
            const body = {
                companyName: document.getElementById('we_company').value,
                position: document.getElementById('we_position').value,
                startDate: document.getElementById('we_start').value,
                endDate: document.getElementById('we_end').value,
                isCurrent: document.getElementById('we_current').value==='1',
                description: document.getElementById('we_desc').value,
                achievements: ''
            };
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=add-work-experience`, { method:'POST', headers:{ 'Authorization':`Bearer ${authToken}`, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success) { closeModal('weModal'); showProfileTab('work-experience'); showMessage('Work experience added','success'); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to add work experience','error'); }
        }

        function openEditWorkExpModal(id) {
            // Minimal edit prompts
            const companyName = prompt('Company'); if (companyName===null) return;
            const position = prompt('Position'); if (position===null) return;
            const startDate = prompt('Start date (YYYY-MM-DD)'); if (startDate===null) return;
            const endDate = prompt('End date (YYYY-MM-DD, blank if current)');
            const isCurrent = !endDate;
            const description = prompt('Description','') || '';
            saveWorkExp(id, { companyName, position, startDate, endDate: endDate||null, isCurrent, description, achievements:'' });
        }

        async function saveWorkExp(id, values) {
            const body = Object.assign({ id }, values || {
                companyName: document.getElementById('we_company').value,
                position: document.getElementById('we_position').value,
                startDate: document.getElementById('we_start').value,
                endDate: document.getElementById('we_end').value,
                isCurrent: document.getElementById('we_current').value==='1',
                description: document.getElementById('we_desc').value,
                achievements: ''
            });
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=update-work-experience`, { method:'PUT', headers:{ 'Authorization':`Bearer ${authToken}`, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success) { closeModal('weModal'); showProfileTab('work-experience'); showMessage('Work experience saved','success'); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to save work experience','error'); }
        }

        async function deleteWorkExp(id) {
            if (!confirm('Delete this experience?')) return;
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=delete-work-experience&id=${id}`, { method:'DELETE', headers:{ 'Authorization':`Bearer ${authToken}` }});
                const data = await res.json();
                if (data.success) { showProfileTab('work-experience'); showMessage('Work experience deleted','success'); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to delete work experience','error'); }
        }

        function renderProviderProfile(pp) {
            const container = document.getElementById('profileTabContent');
            const profile = pp || {};
            container.innerHTML = `
                <div class='card'>
                    <div class='form-group'><label class='form-label'>Business Name</label><input id='bp_name' class='form-input' value='${profile.business_name||''}'></div>
                    <div class='form-group' style='display:flex; gap:10px;'>
                        <div style='flex:1'><label class='form-label'>Experience (years)</label><input id='bp_exp' type='number' class='form-input' value='${profile.experience_years||0}'></div>
                        <div style='flex:1'><label class='form-label'>Hourly Rate (₹)</label><input id='bp_rate' type='number' class='form-input' value='${profile.hourly_rate||0}'></div>
                        <div style='flex:1'><label class='form-label'>Service Radius (km)</label><input id='bp_radius' type='number' class='form-input' value='${profile.service_radius||10}'></div>
                    </div>
                    <div class='form-group'><label class='form-label'>Languages (comma-separated)</label><input id='bp_lang' class='form-input' value='${(profile.languages_spoken? JSON.parse(profile.languages_spoken).join(', '):'')}'></div>
                    <div class='form-group'><label class='form-label'>Specializations (comma-separated)</label><input id='bp_specs' class='form-input' value='${(profile.specializations? JSON.parse(profile.specializations).join(', '):'')}'></div>
                    <div class='form-group'><label class='form-label'>Business License</label><input id='bp_license' class='form-input' value='${profile.business_license||''}'></div>
                    <div class='form-group'><label class='form-label'>Insurance Details</label><input id='bp_ins' class='form-input' value='${profile.insurance_details||''}'></div>
                    <div style='display:flex; gap:10px; justify-content:flex-end;'>
                        <button class='btn btn-primary' onclick='saveProviderProfile()'><i class="fas fa-save"></i> Save Details</button>
                    </div>
                </div>
            `;
        }

        async function saveProviderProfile() {
            const body = {
                businessName: document.getElementById('bp_name').value,
                experienceYears: parseInt(document.getElementById('bp_exp').value||'0',10),
                hourlyRate: parseFloat(document.getElementById('bp_rate').value||'0'),
                serviceRadius: parseInt(document.getElementById('bp_radius').value||'10',10),
                languagesSpoken: document.getElementById('bp_lang').value.split(',').map(s=>s.trim()).filter(Boolean),
                specializations: document.getElementById('bp_specs').value.split(',').map(s=>s.trim()).filter(Boolean),
                businessLicense: document.getElementById('bp_license').value,
                insuranceDetails: document.getElementById('bp_ins').value,
                emergencyServices: false,
                freeConsultation: true
            };
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=update-provider-profile`, { method:'PUT', headers:{ 'Authorization':`Bearer ${authToken}`, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success) showMessage('Business profile saved','success'); else showMessage(data.message,'error');
            } catch(e){ showMessage('Failed to save','error'); }
        }

        async function editProfile() {
            // Simple inline edit for user name/phone/bio/social links
            const name = prompt('Full name', currentUser?.full_name || ''); if (name===null) return;
            const phone = prompt('Phone', currentUser?.phone || ''); if (phone===null) return;
            const bio = prompt('Bio (short about you)', '');
            const socialLinks = { facebook: '', instagram: '', linkedin: '' };
            try {
                const res = await fetch(`${API_BASE}/profiles.php?action=update-profile`, { method: 'PUT', headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ fullName: name, phone, bio, socialLinks }) });
                const data = await res.json();
                if (data.success) { showMessage('Profile updated','success'); showProfileView(); } else { showMessage(data.message,'error'); }
            } catch(e){ showMessage('Failed to update profile','error'); }
        }
        
        async function loadServices(searchQuery = '') {
            try {
                const url = searchQuery
                    ? `${API_BASE}/services.php?action=list&search=${encodeURIComponent(searchQuery)}`
                    : `${API_BASE}/services.php?action=list`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    renderServices(data.data.services);
                } else {
                    showMessage('Failed to load services', 'error');
                }
            } catch (error) {
                console.error('Load services error:', error);
                showMessage('Network error loading services', 'error');
            }
        }

        function renderServices(services) {
            const container = document.getElementById('servicesContainer');
            
            if (services.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 50px;">
                        <i class="fas fa-search" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
                        <h3>No services found</h3>
                        <p style="color: #666;">Try adjusting your search criteria</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    ${services.map(service => `
                        <div class="card" style="position: relative;">
                            ${service.is_featured ? '<div style="position: absolute; top: 15px; right: 15px; background: #ff9800; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: 600;"><i class="fas fa-star"></i> Featured</div>' : ''}
                            
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div class="profile-avatar" style="width: 60px; height: 60px;">
                                    ${service.provider_name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 style="margin: 0 0 5px 0; color: #333;">${service.title}</h3>
                                    <p style="margin: 0; color: #666;">by ${service.provider_name}</p>
                                    <div style="margin-top: 5px;">
                                        <span class="rating-stars">
                                            ${'★'.repeat(Math.floor(service.provider_rating || 4))}${'☆'.repeat(5 - Math.floor(service.provider_rating || 4))}
                                        </span>
                                        <small style="color: #666;">(${service.total_reviews || 0} reviews)</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                <h4 style="color: #4CAF50; margin: 0 0 10px 0; font-size: 1.5rem;">₹${service.price}</h4>
                                <p style="margin: 0; color: #666; line-height: 1.5;">${service.description}</p>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <span class="badge badge-info">${service.category}</span>
                                <span class="badge badge-success">${service.location}</span>
                            </div>
                            
                            <button class="btn btn-primary" style="width: 100%;" onclick="openBookingModal(${service.id})">
                                <i class="fas fa-calendar-plus"></i> Book Now
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function searchServices() {
            const query = document.getElementById('searchInput').value.trim();
            const category = document.getElementById('categoryFilter').value;
            
            let searchQuery = query;
            if (category) {
                searchQuery += (query ? ' ' : '') + category;
            }
            
            loadServices(searchQuery);
        }

        // Profile management functions
        async function showProfileView() {
            const mainContent = document.getElementById('mainContent');
            
            try {
                const response = await fetch(`${API_BASE}/profiles.php?action=get-profile`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    renderProfile(data.data.profile);
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
                showMessage('Failed to load profile', 'error');
            }
        }

        function renderProfile(profile) {
            const mainContent = document.getElementById('mainContent');
            
            mainContent.innerHTML = `
                <div class="card">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            ${profile.full_name.charAt(0).toUpperCase()}
                        </div>
                        <div style="flex: 1;">
                            <h2 style="margin: 0 0 5px 0; color: #333;">
                                ${profile.full_name}
                                ${profile.is_verified ? '<span class="verified-badge"><i class="fas fa-shield-alt"></i> Verified</span>' : ''}
                            </h2>
                            <p style="margin: 0 0 5px 0; color: #666;">${profile.email}</p>
                            ${profile.role === 'provider' && profile.rating > 0 ? `
                                <div class="rating-stars">
                                    ${'★'.repeat(Math.floor(profile.rating))}${'☆'.repeat(5 - Math.floor(profile.rating))}
                                    <span style="color: #666; font-size: 14px; margin-left: 5px;">${profile.rating}/5 (${profile.total_reviews} reviews)</span>
                                </div>
                            ` : ''}
                        </div>
                        <button class="btn btn-primary" onclick="editProfile()">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                    </div>

                    ${profile.bio ? `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <h4><i class="fas fa-info-circle"></i> About</h4>
                            <p style="margin: 10px 0 0 0;">${profile.bio}</p>
                        </div>
                    ` : ''}

                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        ${profile.role === 'provider' ? `
                            <div class="stat-card">
                                <div class="stat-number">${profile.services_count || 0}</div>
                                <div class="stat-label">Services Offered</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${profile.portfolio_count || 0}</div>
                                <div class="stat-label">Portfolio Items</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${profile.certificates_count || 0}</div>
                                <div class="stat-label">Certificates</div>
                            </div>
                        ` : ''}
                        <div class="stat-card">
                            <div class="stat-number">${profile.total_bookings || 0}</div>
                            <div class="stat-label">${profile.role === 'provider' ? 'Jobs Completed' : 'Services Booked'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${new Date(profile.created_at).getFullYear()}</div>
                            <div class="stat-label">Member Since</div>
                        </div>
                    </div>
                </div>

                ${profile.role === 'provider' ? `
                    <div class="tabs">
                        <div class="tab active" onclick="showProfileTab('portfolio')">
                            <i class="fas fa-images"></i> Portfolio
                        </div>
                        <div class="tab" onclick="showProfileTab('certificates')">
                            <i class="fas fa-certificate"></i> Certificates
                        </div>
                        <div class="tab" onclick="showProfileTab('business-hours')">
                            <i class="fas fa-clock"></i> Business Hours
                        </div>
                        <div class="tab" onclick="showProfileTab('service-areas')">
                            <i class="fas fa-map-marker-alt"></i> Service Areas
                        </div>
                        <div class="tab" onclick="showProfileTab('work-experience')">
                            <i class="fas fa-user-tie"></i> Work Experience
                        </div>
                        <div class="tab" onclick="showProfileTab('provider-profile')">
                            <i class="fas fa-briefcase"></i> Business Details
                        </div>
                    </div>

                    <div id="profileTabContent">
                        <!-- Tab content will be loaded here -->
                    </div>
                ` : ''}
            `;

            if (profile.role === 'provider') {
                showProfileTab('portfolio');
            }
        }

        // Authentication functions
        function showAuthModal() {
            // Create and show authentication modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'authModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Welcome to QuickServe Pro</h2>
                        <span class="close" onclick="closeModal('authModal')">&times;</span>
                    </div>

                    <div class="tabs" style="background: #f8f9fa;">
                        <div class="tab active" style="color: #333;" onclick="switchAuthTab('login')">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </div>
                        <div class="tab" style="color: #333;" onclick="switchAuthTab('signup')">
                            <i class="fas fa-user-plus"></i> Sign Up
                        </div>
                    </div>

                    <div class="message" id="authMessage"></div>

                    <!-- Login Form -->
                    <div id="loginForm">
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                        </div>
                        <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="login()">
                            <i class="fas fa-sign-in-alt"></i> Login to Account
                        </button>
                    </div>

                    <!-- Signup Form -->
                    <div id="signupForm" class="hidden">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="signupName" placeholder="Enter your full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="signupEmail" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="signupPhone" placeholder="Enter your phone number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-input" id="signupPassword" placeholder="Create a strong password" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">I want to</label>
                            <select class="form-select" id="signupRole" required>
                                <option value="customer">Book Services (Customer)</option>
                                <option value="provider">Provide Services (Service Provider)</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" style="width: 100%; justify-content: center;" onclick="signup()">
                            <i class="fas fa-user-plus"></i> Create Account
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        function switchAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabs = document.querySelectorAll('#authModal .tab');

            tabs.forEach(t => t.classList.remove('active'));

            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                tabs[0].classList.add('active');
            } else {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                tabs[1].classList.add('active');
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('Please fill in all fields', 'error', 'authMessage');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth.php?action=login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data.data.user;
                    authToken = data.data.token;
                    localStorage.setItem('quickserve_token', authToken);

                    closeModal('authModal');
                    updateNavigation();
                    showMessage(`Welcome back, ${currentUser.full_name}!`, 'success');
                    
                    // Redirect based on role
                    if (currentUser.role === 'admin') {
                        showView('admin-dashboard');
                    } else if (currentUser.role === 'provider') {
                        showView('provider-dashboard');
                    } else {
                        showView('home');
                    }
                } else {
                    showMessage(data.message || 'Login failed', 'error', 'authMessage');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Network error. Please try again.', 'error', 'authMessage');
            }
        }

        async function signup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const phone = document.getElementById('signupPhone').value;
            const password = document.getElementById('signupPassword').value;
            const role = document.getElementById('signupRole').value;

            if (!name || !email || !password || !role) {
                showMessage('Please fill in all required fields', 'error', 'authMessage');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth.php?action=signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fullName: name,
                        email,
                        phone,
                        password,
                        role
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data.data.user;
                    authToken = data.data.token;
                    localStorage.setItem('quickserve_token', authToken);

                    closeModal('authModal');
                    updateNavigation();
                    showMessage(`Welcome to QuickServe Pro, ${currentUser.full_name}!`, 'success');
                    
                    // Show appropriate view based on role
                    if (currentUser.role === 'provider') {
                        showView('my-profile');
                    } else {
                        showView('home');
                    }
                } else {
                    showMessage(data.message || 'Signup failed', 'error', 'authMessage');
                }
            } catch (error) {
                console.error('Signup error:', error);
                showMessage('Network error. Please try again.', 'error', 'authMessage');
            }
        }

        function logout() {
            currentUser = null;
            authToken = null;
            localStorage.removeItem('quickserve_token');
            updateNavigation();
            showView('home');
            showMessage('You have been logged out successfully', 'info');
        }

        // Utility functions
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        function showMessage(message, type = 'info', messageId = 'globalMessage') {
            // Remove existing message
            const existingMessage = document.getElementById(messageId);
            if (existingMessage) {
                existingMessage.remove();
            }

            // Create new message
            const messageEl = document.createElement('div');
            messageEl.id = messageId;
            messageEl.className = `message ${type}`;
            messageEl.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; margin-left: auto;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            // Insert at the beginning of main content
            const mainContent = document.getElementById('mainContent');
            mainContent.insertBefore(messageEl, mainContent.firstChild);

            // Auto hide after 5 seconds
            setTimeout(() => {
                if (messageEl && messageEl.parentNode) {
                    messageEl.remove();
                }
            }, 5000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.remove();
            }
        }

        // Search on Enter key
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.id === 'searchInput') {
                searchServices();
            }
        });
    </script>
</body>
</html>